// Словарь ударений для русских слов (популярные финансовые и общие термины)
const STRESS_DICTIONARY: { [key: string]: string } = {
  // Финансовые термины
  "анализ": "ана́лиз",
  "валюта": "валю́та",
  "доллар": "до́ллар",
  "доходы": "дохо́ды",
  "инвестор": "инве́стор",
  "капитал": "капита́л",
  "маржа": "ма́ржа",
  "портфель": "портфе́ль",
  "прибыль": "при́быль",
  "процент": "проце́нт",
  "рубль": "рубль",
  "сделка": "сде́лка",
  "торговля": "торго́вля",
  "трейдер": "тре́йдер",
  "трейдинг": "тре́йдинг",
  "убыток": "убы́ток",
  "фондовый": "фо́ндовый",
  "форекс": "фо́рекс",
  "цена": "цена́",
  "экономика": "эконо́мика",
  
  // Общие слова с частыми ошибками ударения
  "замок_крепость": "за́мок", // крепость
  "замок_устройство": "замо́к", // устройство для запирания
  "банкир": "банки́р",
  "договор": "догово́р",
  "звонит": "звони́т",
  "квартал": "кварта́л",
  "красивее": "краси́вее",
  "обеспечение": "обеспе́чение",
  "торты": "то́рты",
  "каталог": "катало́г",
  "начать": "нача́ть",
  "принять": "приня́ть",
  "включит": "включи́т",
  "километр": "киломе́тр",
  "документ": "докуме́нт",
  "эксперт": "экспе́рт",
  "партнер": "партнёр",
  "менеджер": "ме́неджер",
  "маркетинг": "ма́ркетинг",
  "кредит": "креди́т",
  "депозит": "депози́т",
  "дивиденд": "дивиде́нд"
};

export function applyStressMarks(text: string): string {
  let result = text;
  
  // Применяем словарь ударений
  Object.entries(STRESS_DICTIONARY).forEach(([word, stressed]) => {
    const regex = new RegExp(`\\b${word}\\b`, 'gi');
    result = result.replace(regex, stressed);
  });
  
  return result;
}

export function normalizeTextForTTS(text: string, useStressDict: boolean = true): string {
  let normalized = text;
  
  // Удаляем временные метки из субтитров
  normalized = normalized.replace(/\d{2}:\d{2}:\d{2},\d{3}\s*-->\s*\d{2}:\d{2}:\d{2},\d{3}/g, '');
  
  // Удаляем номера блоков субтитров
  normalized = normalized.replace(/^\d+$/gm, '');
  
  // Удаляем лишние пробелы и переносы строк
  normalized = normalized.replace(/\n+/g, ' ').replace(/\s+/g, ' ').trim();
  
  // Применяем словарь ударений если включен
  if (useStressDict) {
    normalized = applyStressMarks(normalized);
  }
  
  // Добавляем паузы после предложений
  normalized = normalized.replace(/[.!?]/g, '$&... ');
  
  // Замена сокращений на полные формы
  const abbreviations: { [key: string]: string } = {
    'USD': 'доллар США',
    'EUR': 'евро',
    'RUB': 'рубль',
    'BTC': 'биткоин',
    'ETH': 'эфириум',
    'т.е.': 'то есть',
    'т.к.': 'так как',
    'т.п.': 'тому подобное',
    'и т.д.': 'и так далее',
    'и т.п.': 'и тому подобное'
  };
  
  Object.entries(abbreviations).forEach(([abbr, full]) => {
    const regex = new RegExp(`\\b${abbr.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')}\\b`, 'gi');
    normalized = normalized.replace(regex, full);
  });
  
  return normalized;
}